const palette = {
	dark: {
		highlight: "#0d419d",
		highlight2: "#0c2d6b",
		accent: {
			emphasis: "#1f6feb",
			fg: "#58a6ff",
			muted: "#388bfd66",
			subtle: "#388bfd26",
		},
		attention: {
			emphasis: "#9e6a03",
			fg: "#d29922",
			muted: "#bb800966",
			subtle: "#bb800926",
		},
		border: {
			default: "#30363d",
			muted: "#21262d",
			subtle: "#f0f6fc1a",
		},
		canvas: {
			default: "#0d1117",
			inset: "#010409",
			overlay: "#161b22",
			subtle: "#161b22",
		},
		closed: {
			emphasis: "#da3633",
			fg: "#f85149",
			muted: "#f8514966",
			subtle: "#f8514926",
		},
		danger: {
			emphasis: "#da3633",
			fg: "#f85149",
			muted: "#f8514966",
			subtle: "#f8514926",
		},
		done: {
			emphasis: "#8957e5",
			fg: "#a371f7",
			muted: "#a371f766",
			subtle: "#a371f726",
		},
		fg: {
			default: "#c9d1d9",
			muted: "#8b949e",
			onEmphasis: "#ffffff",
			subtle: "#6e7681",
		},
		neutral: {
			emphasis: "#6e7681",
			emphasisPlus: "#6e7681",
			muted: "#6e768166",
			subtle: "#6e76811a",
		},
		open: {
			emphasis: "#238636",
			fg: "#3fb950",
			muted: "#2ea04366",
			subtle: "#2ea04326",
		},

		scale: {
			black: "#010409",
			blue: [
				"#cae8ff",
				"#a5d6ff",
				"#79c0ff",
				"#58a6ff",
				"#388bfd",
				"#1f6feb",
				"#1158c7",
				"#0d419d",
				"#0c2d6b",
				"#051d4d",
			],
			coral: [
				"#ffddd2",
				"#ffc2b2",
				"#ffa28b",
				"#f78166",
				"#ea6045",
				"#cf462d",
				"#ac3220",
				"#872012",
				"#640d04",
				"#460701",
			],
			gray: [
				"#f0f6fc",
				"#c9d1d9",
				"#b1bac4",
				"#8b949e",
				"#6e7681",
				"#484f58",
				"#30363d",
				"#21262d",
				"#161b22",
				"#0d1117",
			],
			green: [
				"#aff5b4",
				"#7ee787",
				"#56d364",
				"#3fb950",
				"#2ea043",
				"#238636",
				"#196c2e",
				"#0f5323",
				"#033a16",
				"#04260f",
			],
			orange: [
				"#ffdfb6",
				"#ffc680",
				"#ffa657",
				"#f0883e",
				"#db6d28",
				"#bd561d",
				"#9b4215",
				"#762d0a",
				"#5a1e02",
				"#3d1300",
			],
			pink: [
				"#ffdaec",
				"#ffbedd",
				"#ff9bce",
				"#f778ba",
				"#db61a2",
				"#bf4b8a",
				"#9e3670",
				"#7d2457",
				"#5e103e",
				"#42062a",
			],
			purple: [
				"#eddeff",
				"#e2c5ff",
				"#d2a8ff",
				"#bc8cff",
				"#a371f7",
				"#8957e5",
				"#6e40c9",
				"#553098",
				"#3c1e70",
				"#271052",
			],
			red: [
				"#ffdcd7",
				"#ffc1ba",
				"#ffa198",
				"#ff7b72",
				"#f85149",
				"#da3633",
				"#b62324",
				"#8e1519",
				"#67060c",
				"#490202",
			],
			white: "#ffffff",
			yellow: [
				"#f8e3a1",
				"#f2cc60",
				"#e3b341",
				"#d29922",
				"#bb8009",
				"#9e6a03",
				"#845306",
				"#693e00",
				"#4b2900",
				"#341a00",
			],
		},
		severe: {
			emphasis: "#bd561d",
			fg: "#db6d28",
			muted: "#db6d2866",
			subtle: "#db6d2826",
		},
		sponsors: {
			emphasis: "#bf4b8a",
			fg: "#db61a2",
			muted: "#db61a266",
			subtle: "#db61a226",
		},
		success: {
			emphasis: "#238636",
			fg: "#3fb950",
			muted: "#2ea04366",
			subtle: "#2ea04326",
		},
	},

	light: {
		highlight: "#ddf4ff",
		highlight2: "#b6e3ff",
		accent: {
			emphasis: "#0969da",
			fg: "#0969da",
			muted: "#54aeff66",
			subtle: "#ddf4ff",
		},

		attention: {
			emphasis: "#bf8700",
			fg: "#9a6700",
			muted: "#d4a72c66",
			subtle: "#fff8c5",
		},
		border: {
			default: "#d0d7de",
			muted: "#d8dee4",
			subtle: "#1b1f2426",
		},
		canvas: {
			default: "#ffffff",
			inset: "#f6f8fa",
			overlay: "#ffffff",
			subtle: "#f6f8fa",
		},
		closed: {
			emphasis: "#cf222e",
			fg: "#cf222e",
			muted: "#ff818266",
			subtle: "#ffebe9",
		},

		danger: {
			emphasis: "#cf222e",
			fg: "#cf222e",
			muted: "#ff818266",
			subtle: "#ffebe9",
		},

		done: {
			emphasis: "#8250df",
			fg: "#8250df",
			muted: "#c297ff66",
			subtle: "#fbefff",
		},

		fg: {
			onEmphasis: "#ffffff",
			subtle: "#6e7781",
			default: "#24292f",
			muted: "#57606a",
		},

		neutral: {
			emphasis: "#6e7781",
			emphasisPlus: "#24292f",
			muted: "#afb8c133",
			subtle: "#eaeef280",
		},

		open: {
			emphasis: "#2da44e",
			fg: "#1a7f37",
			muted: "#4ac26b66",
			subtle: "#dafbe1",
		},

		scale: {
			black: "#1b1f24",
			blue: [
				"#ddf4ff",
				"#b6e3ff",
				"#80ccff",
				"#54aeff",
				"#218bff",
				"#0969da",
				"#0550ae",
				"#033d8b",
				"#0a3069",
				"#002155",
			],
			coral: [
				"#fff0eb",
				"#ffd6cc",
				"#ffb4a1",
				"#fd8c73",
				"#ec6547",
				"#c4432b",
				"#9e2f1c",
				"#801f0f",
				"#691105",
				"#510901",
			],
			gray: [
				"#f6f8fa",
				"#eaeef2",
				"#d0d7de",
				"#afb8c1",
				"#8c959f",
				"#6e7781",
				"#57606a",
				"#424a53",
				"#32383f",
				"#24292f",
			],
			green: [
				"#dafbe1",
				"#aceebb",
				"#6fdd8b",
				"#4ac26b",
				"#2da44e",
				"#1a7f37",
				"#116329",
				"#044f1e",
				"#003d16",
				"#002d11",
			],
			orange: [
				"#fff1e5",
				"#ffd8b5",
				"#ffb77c",
				"#fb8f44",
				"#e16f24",
				"#bc4c00",
				"#953800",
				"#762c00",
				"#5c2200",
				"#471700",
			],
			pink: [
				"#ffeff7",
				"#ffd3eb",
				"#ffadda",
				"#ff80c8",
				"#e85aad",
				"#bf3989",
				"#99286e",
				"#772057",
				"#611347",
				"#4d0336",
			],
			purple: [
				"#fbefff",
				"#ecd8ff",
				"#d8b9ff",
				"#c297ff",
				"#a475f9",
				"#8250df",
				"#6639ba",
				"#512a97",
				"#3e1f79",
				"#2e1461",
			],
			red: [
				"#ffebe9",
				"#ffcecb",
				"#ffaba8",
				"#ff8182",
				"#fa4549",
				"#cf222e",
				"#a40e26",
				"#82071e",
				"#660018",
				"#4c0014",
			],
			white: "#ffffff",
			yellow: [
				"#fff8c5",
				"#fae17d",
				"#eac54f",
				"#d4a72c",
				"#bf8700",
				"#9a6700",
				"#7d4e00",
				"#633c01",
				"#4d2d00",
				"#3b2300",
			],
		},

		severe: {
			emphasis: "#bc4c00",
			fg: "#bc4c00",
			muted: "#fb8f4466",
			subtle: "#fff1e5",
		},

		sponsors: {
			emphasis: "#bf3989",
			fg: "#bf3989",
			muted: "#ff80c866",
			subtle: "#ffeff7",
		},

		success: {
			emphasis: "#2da44e",
			fg: "#1a7f37",
			muted: "#4ac26b66",
			subtle: "#dafbe1",
		},
	},
};

const no = "#ffffff";
const test = "#ff0000";

const makeTheme = (p) => ({
	colors: {
		frame: p.canvas.default,
		frame_inactive: p.canvas.default,
		// tab_background_text: p.fg.muted,
		tab_background_text: p.fg.default,
		tab_background_separator: p.border.muted,
		tab_line: p.border.muted,
		tab_loading: p.highlight2,
		tab_selected: p.canvas.overlay,
		tab_text: p.fg.default,
		toolbar: p.canvas.subtle,
		toolbar_bottom_separator: p.border.default,
		toolbar_field: p.canvas.overlay,
		toolbar_field_border: p.border.muted,
		toolbar_field_border_focus: p.border.default,
		toolbar_field_focus: p.canvas.overlay,
		toolbar_field_highlight: p.highlight,
		toolbar_field_highlight_text: p.fg.default,
		toolbar_field_separator: p.border.subtle,
		toolbar_field_text: p.fg.muted,
		toolbar_field_text_focus: p.fg.default,
		toolbar_top_separator: p.border.muted,
		toolbar_vertical_separator: p.border.muted,
		toolbar_text: p.fg.default,
		bookmark_text: p.fg.default,
		button_background_active: p.canvas.overlay,
		button_background_hover: p.canvas.subtle,
		icons: p.fg.subtle,
		icons_attention: p.fg.default,
		ntp_background: p.canvas.default,
		ntp_card_background: p.canvas.overlay,
		ntp_text: p.fg.default,
		popup: p.canvas.overlay,
		popup_border: p.border.default,
		popup_text: p.fg.default,
		popup_highlight: p.highlight,
		popup_highlight_text: p.fg.default,
		sidebar: p.canvas.overlay,
		sidebar_border: p.border.default,
		sidebar_text: p.fg.default,
		sidebar_highlight: p.highlight,
		sidebar_highlight_text: p.fg.default,
	},
	properties: {
		color_scheme: "system",
		content_color_scheme: "system",
	},
});

const themes = {
	light: makeTheme(palette.light),
	dark: makeTheme(palette.dark),
};

let current = null;

async function setTheme(theme) {
	try {
		if (current === theme) return;
		current = theme;
		const res = await browser.theme.update(themes[theme]);
		console.log(res);
	} catch (e) {
		console.error("Failed to set theme", e);
	}
}

function setSystemTheme(dark = undefined) {
	const pref =
		dark !== undefined
			? dark
			: window.matchMedia("(prefers-color-scheme: dark)").matches
				? "dark"
				: "light";
	return setTheme(pref);
}

async function main() {
	await setSystemTheme();
	browser.runtime.onMessage.addListener((req) => {
		if (!("scheme" in req) || req.scheme === current) return;

		setSystemTheme(req.scheme);
	});
}

main();
